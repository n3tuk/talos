---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: 3

tasks:
  jsonschema:
    desc: Validation the schema of configuration files in the repository
    summary: |-
      Validate the layout and content of the YAML files in this repository
      using the JSON Schema files, including:

      - Taskfiles (Taskfile.yaml, .taskfiles/*.yaml)
      - GitHub Workflows (.github/workflows/*.yaml)
      - pre-commit Configuration (.pre-commit-config)
      - Talos Machine Configuration (*/{common,machines}/*.yaml)
    silent: true
    deps:
      - task: yamllint
    cmds:
      - task: jsonschema:taskfiles
      - task: jsonschema:workflows
      - task: jsonschema:pre-commit-config
      - task: jsonschema:talos

  jsonschema:taskfiles:
    internal: true
    silent: true
    sources:
      - Taskfile.yaml
      - .taskfiles/*.yaml
    cmds:
      - cmd: |-
          check-jsonschema \
            --output-format text --no-cache --verbose \
            --builtin-schema vendor.taskfile \
            Taskfile.yaml .taskfiles/*.yaml
          echo -e '{{ .cg }}Passed{{ .cc }}'

  jsonschema:workflows:
    internal: true
    silent: true
    sources:
      - .github/workflows/*.yaml
    vars:
      files:
        sh: |-
          find .github/workflows \
            -ignore_readdir_race \
            -type f \
            -iname '*.yaml' \
            -printf '.github/workflows/%P ' \
          2>/dev/null || true
    cmds:
      - cmd: |-
          [[ -z '{{ .files }}' ]] && exit 0
          check-jsonschema \
            --output-format text --verbose \
            --builtin-schema vendor.github-workflows \
            {{ .files }}
          echo -e '{{ .cg }}Passed{{ .cc }}'

  jsonschema:pre-commit-config:
    internal: true
    silent: true
    sources:
      - .pre-commit-config.yaml
    cmds:
      # yamllint disable rule:line-length
      - cmd: |-
          [[ -f .pre-commit-config.yaml ]] || exit 0
          check-jsonschema \
            --output-format text --verbose \
            --cache-filename pre-commit-config.json \
            --schemafile https://raw.githubusercontent.com/SchemaStore/schemastore/master/src/schemas/json/pre-commit-config.json \
            .pre-commit-config.yaml
          echo -e '{{ .cg }}Passed{{ .cc }}'
      # yamllint enable rule:line-length

  jsonschema:talos:
    internal: true
    silent: true
    sources:
      - development/*/*.yaml
      - production/*/*.yaml
    vars:
      files:
        sh: |-
          find . \
              -ignore_readdir_race \
              -type f \
           \( -path './development/*' \
           -o -path './production/*' \
           \) -a -iname '*.yaml' \
              -a ! -iname 'secrets.yaml' \
              -printf '%P ' \
          2>/dev/null || true
    cmds:
      # yamllint disable rule:line-length
      - cmd: |-
          [[ -z '{{ .files }}' ]] && exit 0
          check-jsonschema \
            --output-format text --verbose \
            --cache-filename talos.json \
            --schemafile https://docs.siderolabs.com/talos/v1.12/schemas/v1alpha1_config.schema.json \
            {{ .files }}
          echo -e '{{ .cg }}Passed{{ .cc }}'
      # yamllint enable rule:line-length
